<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   
<mapper namespace="com.myboot.admin.user.dao.AdminUserDAO">

	<resultMap id="userResult" type="java.util.HashMap">
      <result property="id" column="USER_ID" />
      <result property="pw" column="USER_PW" />
      <result property="name" column="USER_NAME" />
      <result property="email" column="USER_EMAIL" />
      <result property="tel" column="USER_TEL" />
      <result property="tel_sub" column="USER_TEL_SUB" />
      <result property="message" column="USER_MESSAGE" />
      <result property="birth" column="USER_BIRTH" />
      <result property="joinDate" column="JOINDATE" />
      <result property="grade" column="USER_GRADE" />
      <result property="resState" column="RES_STATE" />
   </resultMap> 
	
	<select id="selectAllUserList" resultMap="userResult">
      <![CDATA[
        select U.USER_ID, USER_NAME, USER_EMAIL, USER_TEL, JOINDATE, USER_GRADE, REPLACE(NVL(max(RESERVATION_STATE),'X'),'N','O') RES_STATE
		    from TB_USER U 
		    LEFT JOIN ( select user_id, RESERVATION_STATE from TB_RESERVATION WHERE RESERVATION_STATE='N' ) R
		ON U.user_id = R.user_id 
		GROUP BY U.USER_ID, USER_NAME, USER_EMAIL, USER_TEL, JOINDATE, USER_GRADE
		order by joinDate desc
      ]]>
   </select>
  
   <select id="searchUsers" parameterType="java.util.Map" resultMap="userResult">
      <![CDATA[
        select U.USER_ID, USER_NAME, USER_EMAIL, USER_TEL, JOINDATE, USER_GRADE, REPLACE(NVL(max(RESERVATION_STATE),'X'),'N','O') RES_STATE
		    from TB_USER U 
		    LEFT JOIN ( select user_id, RESERVATION_STATE from TB_RESERVATION WHERE RESERVATION_STATE='N' ) R
		ON U.user_id = R.user_id  ]]>
		<where>
			 <choose>
			 	<when test="search_op=='search_id'">
			 		U.USER_ID LIKE '%'||#{keyword}||'%'
			 	</when>
			 	<when test="search_op=='search_name'">
			 		USER_NAME LIKE '%'||#{keyword}||'%'
			 	</when>
			 	<when test="search_op=='search_tel'">
			 		USER_TEL LIKE '%'||#{keyword}||'%'
			 	</when>
			 	<when test="search_op=='search_email'">
			 		USER_EMAIL LIKE '%'||#{keyword}||'%'
			 	</when>
			 </choose>
		
			<choose>
				<when test="grade!='' and grade!=null and grade2!='' and grade2!=null">
					AND (USER_GRADE=#{grade} OR USER_GRADE=#{grade2}) 
				</when>
				<when test="grade!='' and grade!=null">
					AND USER_GRADE=#{grade}
				</when>
			</choose>
			<choose>
				<when test="res_state!='' and res_state!=null">
					AND REPLACE(NVL(RESERVATION_STATE,'X'),'N','O') = #{res_state}
				</when>
			</choose>
			
		</where>
		GROUP BY U.USER_ID, USER_NAME, USER_EMAIL, USER_TEL, JOINDATE, USER_GRADE
		order by joinDate desc
   </select>
   
	
</mapper>